<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestionale Ordini</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyDIe3Wpg4pGPamkwl5X65am38pDImObX0Y",
    authDomain: "activitystorage-f0589.firebaseapp.com",
    projectId: "activitystorage-f0589",
    storageBucket: "activitystorage-f0589.firebasestorage.app",
    messagingSenderId: "987340237176",
    appId: "1:987340237176:web:d1f9f96c0596f35c4bc08d"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._db = db;
  window._firebase = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot };
  window._firebaseReady = true;
  window.dispatchEvent(new Event('firebaseReady'));
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0a0a0f; --bg2: #111118; --bg3: #1a1a24; --card: #14141e;
    --border: #252535; --accent: #c9a84c; --accent2: #e8c96a;
    --green: #4caf82; --red: #e05252; --blue: #4c7dcf; --purple: #8b5cf6;
    --text: #e8e8f0; --text2: #9090a8; --text3: #60607a;
    --radius: 12px; --radius-sm: 8px;
    --font: 'Inter', system-ui, sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }
  body { background: var(--bg); color: var(--text); font-family: var(--font); font-size: 14px; line-height: 1.5; min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
  body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.35; }

  .layout { display: flex; height: 100vh; }

  /* SIDEBAR */
  .sidebar { width: 230px; background: var(--bg2); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px 0; flex-shrink: 0; position: relative; }
  .sidebar::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 1px; background: linear-gradient(to bottom, transparent, var(--accent), transparent); opacity: 0.25; }
  .logo { padding: 0 20px 24px; border-bottom: 1px solid var(--border); }
  .logo-mark { font-size: 10px; font-family: var(--mono); color: var(--accent); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; }
  .logo h1 { font-size: 20px; font-weight: 800; color: var(--text); line-height: 1.2; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
  .logo h1 em { color: var(--accent); font-style: normal; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; flex-shrink: 0; }
  .sync-dot.offline { background: var(--red); animation: none; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
  .nav { padding: 16px 12px; flex: 1; }
  .nav-section { font-size: 10px; letter-spacing: 2px; color: var(--text3); text-transform: uppercase; font-family: var(--mono); padding: 0 8px; margin: 14px 0 6px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; color: var(--text2); font-size: 13px; font-weight: 500; border: 1px solid transparent; margin-bottom: 2px; }
  .nav-item:hover { background: var(--bg3); color: var(--text); }
  .nav-item.active { background: rgba(201,168,76,0.1); color: var(--accent); border-color: rgba(201,168,76,0.2); }
  .nav-item .icon { font-size: 15px; width: 18px; text-align: center; }
  .nav-badge { margin-left: auto; background: var(--accent); color: #000; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px; font-family: var(--mono); }
  .sidebar-footer { padding: 14px 20px; border-top: 1px solid var(--border); }
  .sidebar-footer .sf-label { font-size: 9px; color: var(--text3); font-family: var(--mono); letter-spacing: 1.5px; text-transform: uppercase; }
  .sidebar-footer .sf-value { font-size: 22px; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; line-height: 1.2; }
  .live-badge { font-size: 9px; font-family: var(--mono); letter-spacing: 1px; margin-top: 4px; }
  .live-badge.on { color: var(--green); } .live-badge.off { color: var(--red); }

  /* MAIN */
  .main { flex: 1; overflow-y: auto; padding: 28px 32px; }
  .main::-webkit-scrollbar { width: 5px; }
  .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
  .page-title { font-size: 24px; font-weight: 800; color: var(--text); line-height: 1; letter-spacing: -0.5px; }
  .page-subtitle { font-size: 12px; color: var(--text2); margin-top: 5px; font-family: var(--mono); }

  /* BUTTONS */
  .btn { display: inline-flex; align-items: center; gap: 7px; padding: 9px 18px; border-radius: var(--radius-sm); font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover:not(:disabled) { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(201,168,76,0.3); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover:not(:disabled) { background: var(--bg3); color: var(--text); }
  .btn-danger { background: rgba(224,82,82,0.12); color: var(--red); border: 1px solid rgba(224,82,82,0.25); }
  .btn-danger:hover:not(:disabled) { background: rgba(224,82,82,0.22); }
  .btn-sm { padding: 5px 11px; font-size: 12px; }

  /* KPI */
  .kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 20px; }
  .kpi-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; position: relative; overflow: hidden; transition: border-color 0.2s, transform 0.2s; }
  .kpi-card:hover { border-color: rgba(201,168,76,0.4); transform: translateY(-1px); }
  .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
  .kpi-card.gold::before { background: linear-gradient(90deg, var(--accent), transparent); }
  .kpi-card.green::before { background: linear-gradient(90deg, var(--green), transparent); }
  .kpi-card.red::before { background: linear-gradient(90deg, var(--red), transparent); }
  .kpi-card.blue::before { background: linear-gradient(90deg, var(--blue), transparent); }
  .kpi-card.purple::before { background: linear-gradient(90deg, var(--purple), transparent); }
  .kpi-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); font-family: var(--mono); margin-bottom: 10px; }
  .kpi-value { font-size: 24px; font-weight: 800; line-height: 1; margin-bottom: 6px; letter-spacing: -1px; }
  .kpi-value.gold { color: var(--accent); } .kpi-value.green { color: var(--green); } .kpi-value.red { color: var(--red); } .kpi-value.purple { color: var(--purple); }
  .kpi-sub { font-size: 11px; color: var(--text3); font-family: var(--mono); }
  .kpi-icon { position: absolute; right: 14px; top: 14px; font-size: 24px; opacity: 0.1; }

  /* TABLE */
  .table-container { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .table-toolbar { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .search-box { display: flex; align-items: center; gap: 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 13px; flex: 1; min-width: 180px; }
  .search-box input { background: none; border: none; color: var(--text); font-family: var(--font); font-size: 13px; outline: none; width: 100%; }
  .search-box input::placeholder { color: var(--text3); }
  .filter-select { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); font-family: var(--font); font-size: 12px; padding: 8px 11px; border-radius: var(--radius-sm); outline: none; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: var(--bg3); border-bottom: 1px solid var(--border); }
  th { padding: 10px 16px; text-align: left; font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); font-family: var(--mono); font-weight: 500; white-space: nowrap; }
  td { padding: 13px 16px; font-size: 13px; border-bottom: 1px solid rgba(37,37,53,0.5); color: var(--text); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.015); }

  /* STATUS */
  .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 600; font-family: var(--mono); white-space: nowrap; }
  .status-badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
  .s-nuovo { background: rgba(76,125,207,0.12); color: var(--blue); }
  .s-lavorazione { background: rgba(201,168,76,0.12); color: var(--accent); }
  .s-spedito { background: rgba(139,92,246,0.12); color: var(--purple); }
  .s-consegnato { background: rgba(76,175,130,0.12); color: var(--green); }
  .s-annullato { background: rgba(224,82,82,0.12); color: var(--red); }

  .amount-pos { color: var(--green); font-family: var(--mono); font-weight: 600; font-size: 13px; }
  .amount-neg { color: var(--red); font-family: var(--mono); font-weight: 600; font-size: 13px; }
  .amount-neutral { color: var(--text2); font-family: var(--mono); font-size: 13px; }
  .mono { font-family: var(--mono); }
  .action-btns { display: flex; gap: 5px; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.15s ease; }
  @keyframes fadeIn { from{opacity:0}to{opacity:1} }
  .modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; width: 100%; max-width: 560px; animation: slideUp 0.2s ease; max-height: 92vh; overflow-y: auto; }
  @keyframes slideUp { from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1} }
  .modal h2 { font-size: 18px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.3px; }
  .modal-sub { font-size: 12px; color: var(--text3); font-family: var(--mono); margin-bottom: 24px; }
  .modal::-webkit-scrollbar { width: 4px; }
  .modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* FORM */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1/-1; }
  .form-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); font-family: var(--mono); }
  .form-input, .form-select, .form-textarea { background: var(--bg3); border: 1px solid var(--border); color: var(--text); font-family: var(--font); font-size: 13px; padding: 9px 13px; border-radius: var(--radius-sm); outline: none; transition: border-color 0.15s; width: 100%; }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 72px; }
  .form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; padding-top: 18px; border-top: 1px solid var(--border); }

  /* Input con unit√† */
  .input-unit-wrap { position: relative; }
  .input-unit-wrap .form-input { padding-right: 42px; }
  .input-unit { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--text3); font-family: var(--mono); pointer-events: none; }

  /* Margine preview */
  .margin-preview { grid-column: 1/-1; background: rgba(76,175,130,0.07); border: 1px solid rgba(76,175,130,0.2); border-radius: var(--radius-sm); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .margin-preview.loss { background: rgba(224,82,82,0.07); border-color: rgba(224,82,82,0.2); }
  .margin-preview-left { display: flex; flex-direction: column; gap: 3px; }
  .margin-preview-label { font-size: 10px; color: var(--text3); font-family: var(--mono); letter-spacing: 1px; text-transform: uppercase; }
  .margin-preview-detail { font-size: 11px; color: var(--text3); font-family: var(--mono); }
  .margin-preview-value { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .margin-preview-value.pos { color: var(--green); } .margin-preview-value.neg { color: var(--red); }

  /* SECTION TITLE */
  .section-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
  .section-title span { font-size: 10px; color: var(--text3); font-family: var(--mono); font-weight: 400; }

  /* MONTHLY CHART */
  .monthly-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
  .month-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .month-card h3 { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); font-family: var(--mono); margin-bottom: 16px; }

  .month-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .month-bar-label { font-size: 11px; color: var(--text2); font-family: var(--mono); width: 36px; flex-shrink: 0; }
  .month-bar-track { flex: 1; height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .month-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }
  .month-bar-val { font-size: 11px; font-family: var(--mono); width: 80px; text-align: right; flex-shrink: 0; }

  /* MISC */
  .dash-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .fin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
  .fin-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .fin-card h3 { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); font-family: var(--mono); margin-bottom: 14px; }
  .empty-state { text-align: center; padding: 56px 20px; color: var(--text3); }
  .empty-state .icon { font-size: 36px; margin-bottom: 14px; opacity: 0.4; }
  .empty-state p { font-size: 13px; }
  .mini-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 9px; }
  .mini-bar-label { font-size: 11px; color: var(--text2); font-family: var(--mono); width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mini-bar-track { flex: 1; height: 5px; background: var(--bg3); border-radius: 3px; overflow: hidden; }
  .mini-bar-fill { height: 100%; border-radius: 3px; }
  .mini-bar-val { font-size: 11px; color: var(--text2); font-family: var(--mono); width: 65px; text-align: right; }
  .tag { display: inline-block; background: var(--bg3); border: 1px solid var(--border); padding: 2px 7px; border-radius: 4px; font-size: 11px; color: var(--text2); font-family: var(--mono); }
  .divider { height: 1px; background: var(--border); margin: 16px 0; }
  .confirm-box { background: rgba(224,82,82,0.07); border: 1px solid rgba(224,82,82,0.2); border-radius: var(--radius-sm); padding: 14px; margin-bottom: 18px; }
  .confirm-box p { font-size: 13px; color: var(--text2); line-height: 1.5; }
  .confirm-box strong { color: var(--red); }
  .loading-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 14px; }
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-size: 12px; color: var(--text3); font-family: var(--mono); letter-spacing: 2px; }

  /* year selector */
  .year-select { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); font-family: var(--mono); font-size: 11px; padding: 4px 8px; border-radius: 6px; outline: none; cursor: pointer; }

  /* RESPONSIVE */
  @media (max-width: 1100px) { .kpi-grid { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 900px) { .sidebar { width: 200px; } .main { padding: 20px 16px; } .monthly-grid { grid-template-columns: 1fr; } .dash-row { grid-template-columns: 1fr; } }
  @media (max-width: 660px) {
    .layout { flex-direction: column; height: auto; min-height: 100vh; }
    .sidebar { width: 100%; padding: 14px 0; }
    .sidebar::after { display: none; }
    .logo { padding: 0 16px 14px; }
    .nav { display: flex; flex-direction: row; padding: 6px 10px; overflow-x: auto; }
    .nav-section { display: none; }
    .nav-item { flex-direction: column; gap: 2px; padding: 8px 12px; font-size: 10px; white-space: nowrap; }
    .nav-item .icon { font-size: 17px; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
    .fin-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    th, td { padding: 9px 11px; font-size: 12px; }
    .main { padding: 14px; }
    .monthly-grid { grid-template-columns: 1fr; }
    .dash-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const n = v => parseFloat(v) || 0;
const fmt = v => `‚Ç¨ ${n(v).toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
const fmtG = v => `${n(v).toLocaleString('it-IT')} g`;
const fmtDate = d => d ? new Date(d).toLocaleDateString('it-IT') : '‚Äî';
const calcMargine = o => (n(o.prezzoVendita) - n(o.prezzoCosto)) * n(o.qta || 1);
const calcFatturato = o => n(o.prezzoVendita) * n(o.qta || 1);
const calcCostoTot = o => n(o.prezzoCosto) * n(o.qta || 1);

const MESI = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
const MESI_FULL = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];

const STATUS_MAP = {
  nuovo:       { label: 'Nuovo',          cls: 's-nuovo' },
  lavorazione: { label: 'In Lavorazione', cls: 's-lavorazione' },
  spedito:     { label: 'Spedito',        cls: 's-spedito' },
  consegnato:  { label: 'Consegnato',     cls: 's-consegnato' },
  annullato:   { label: 'Annullato',      cls: 's-annullato' },
};

// ‚îÄ‚îÄ‚îÄ FIRESTORE HOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useFirestoreCollection(name) {
  const [data, setData] = useState([]);
  const [ready, setReady] = useState(false);
  const unsubRef = useRef(null);
  useEffect(() => {
    const init = () => {
      const { collection, onSnapshot } = window._firebase;
      unsubRef.current = onSnapshot(collection(window._db, name), snap => {
        setData(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        setReady(true);
      }, () => setReady(true));
    };
    if (window._firebaseReady) init();
    else window.addEventListener('firebaseReady', init, { once: true });
    return () => { if (unsubRef.current) unsubRef.current(); };
  }, [name]);
  const add    = useCallback(async item => { const {collection,addDoc}=window._firebase; await addDoc(collection(window._db,name),{...item,_ts:Date.now()}); },[name]);
  const update = useCallback(async (id,item) => { const {doc,updateDoc}=window._firebase; await updateDoc(doc(window._db,name,id),item); },[name]);
  const remove = useCallback(async id => { const {doc,deleteDoc}=window._firebase; await deleteDoc(doc(window._db,name,id)); },[name]);
  return { data, ready, add, update, remove };
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function Modal({ open, onClose, children }) {
  if (!open) return null;
  return (
    <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className="modal">{children}</div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ ORDER FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function OrderForm({ initial, onSave, onClose, title, saving }) {
  const empty = { cliente:'', prodotto:'', qta:'', prezzoVendita:'', prezzoCosto:'', stato:'nuovo', data:new Date().toISOString().split('T')[0], note:'', telefono:'', indirizzo:'' };
  const [f, setF] = useState(initial || empty);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));

  const qta  = n(f.qta);
  const vend = n(f.prezzoVendita);
  const cost = n(f.prezzoCosto);
  const marg = (vend - cost) * (qta || 1);
  const totV = vend * (qta || 1);
  const totC = cost * (qta || 1);
  const hasVals = vend > 0 || cost > 0;

  const save = () => {
    if (!f.cliente || !f.prodotto) return alert('Cliente e Prodotto sono obbligatori');
    onSave(f);
  };

  return (<>
    <h2>{title || 'Nuovo Ordine'}</h2>
    <div className="modal-sub">Inserisci quantit√† in grammi, prezzo di vendita e costo per calcolare il ricavo netto</div>
    <div className="form-grid">
      <div className="form-group"><label className="form-label">Cliente *</label><input className="form-input" value={f.cliente} onChange={set('cliente')} placeholder="Nome cliente"/></div>
      <div className="form-group"><label className="form-label">Telefono</label><input className="form-input" value={f.telefono} onChange={set('telefono')} placeholder="333 1234567"/></div>
      <div className="form-group full"><label className="form-label">Prodotto / Descrizione *</label><input className="form-input" value={f.prodotto} onChange={set('prodotto')} placeholder="Descrizione prodotto o servizio"/></div>

      {/* Quantit√† in grammi */}
      <div className="form-group">
        <label className="form-label">Quantit√† (grammi)</label>
        <div className="input-unit-wrap">
          <input className="form-input" type="number" value={f.qta} onChange={set('qta')} placeholder="es. 50" min="0" step="0.1"/>
          <span className="input-unit">g</span>
        </div>
      </div>

      {/* Prezzo vendita */}
      <div className="form-group">
        <label className="form-label">Prezzo Vendita / g (‚Ç¨) *</label>
        <div className="input-unit-wrap">
          <input className="form-input" type="number" step="0.01" value={f.prezzoVendita} onChange={set('prezzoVendita')} placeholder="0.00"/>
          <span className="input-unit">‚Ç¨/g</span>
        </div>
      </div>

      {/* Prezzo costo */}
      <div className="form-group">
        <label className="form-label">Prezzo Costo / g (‚Ç¨)</label>
        <div className="input-unit-wrap">
          <input className="form-input" type="number" step="0.01" value={f.prezzoCosto} onChange={set('prezzoCosto')} placeholder="0.00"/>
          <span className="input-unit">‚Ç¨/g</span>
        </div>
      </div>

      <div className="form-group">
        <label className="form-label">Stato</label>
        <select className="form-select" value={f.stato} onChange={set('stato')}>
          {Object.entries(STATUS_MAP).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
        </select>
      </div>

      {/* Preview margine */}
      {hasVals && (
        <div className={`margin-preview${marg<0?' loss':''}`}>
          <div className="margin-preview-left">
            <div className="margin-preview-label">Ricavo Netto</div>
            <div className="margin-preview-detail">
              Vendita {fmt(totV)} ‚àí Costo {fmt(totC)} ({qta||1} g)
            </div>
          </div>
          <div className={`margin-preview-value ${marg>=0?'pos':'neg'}`}>
            {marg>=0?'+':''}{fmt(marg)}
          </div>
        </div>
      )}

      <div className="form-group"><label className="form-label">Data</label><input className="form-input" type="date" value={f.data} onChange={set('data')}/></div>
      <div className="form-group full"><label className="form-label">Indirizzo Spedizione</label><input className="form-input" value={f.indirizzo} onChange={set('indirizzo')} placeholder="Via, Citt√†, CAP"/></div>
      <div className="form-group full"><label className="form-label">Note</label><textarea className="form-textarea" value={f.note} onChange={set('note')} placeholder="Note aggiuntive..."/></div>
    </div>
    <div className="form-actions">
      <button className="btn btn-ghost" onClick={onClose} disabled={saving}>Annulla</button>
      <button className="btn btn-primary" onClick={save} disabled={saving}>{saving?'‚è≥ Salvataggio...':'üíæ Salva Ordine'}</button>
    </div>
  </>);
}

// ‚îÄ‚îÄ‚îÄ MOVIMENTO FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function MovimentoForm({ initial, onSave, onClose, title, saving }) {
  const empty = { tipo:'entrata', categoria:'', descrizione:'', importo:'', data:new Date().toISOString().split('T')[0], note:'' };
  const [f, setF] = useState(initial || empty);
  const set = k => e => setF(p=>({...p,[k]:e.target.value}));
  const save = () => { if(!f.descrizione||!f.importo) return alert('Descrizione e Importo obbligatori'); onSave(f); };
  const cats = f.tipo==='entrata' ? ['Vendita','Servizi','Consulenza','Rimborso','Altro'] : ['Fornitore','Spedizione','Materiali','Utenze','Tasse','Software','Altro'];
  return (<>
    <h2>{title||'Nuovo Movimento'}</h2>
    <div className="modal-sub">Registra entrata o uscita aggiuntiva rispetto agli ordini</div>
    <div className="form-grid">
      <div className="form-group"><label className="form-label">Tipo</label>
        <select className="form-select" value={f.tipo} onChange={set('tipo')}>
          <option value="entrata">‚Üò Entrata</option><option value="uscita">‚Üó Uscita</option>
        </select>
      </div>
      <div className="form-group"><label className="form-label">Categoria</label>
        <select className="form-select" value={f.categoria} onChange={set('categoria')}>
          <option value="">Seleziona...</option>{cats.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
      </div>
      <div className="form-group full"><label className="form-label">Descrizione *</label><input className="form-input" value={f.descrizione} onChange={set('descrizione')} placeholder="Descrizione"/></div>
      <div className="form-group"><label className="form-label">Importo (‚Ç¨) *</label><input className="form-input" type="number" step="0.01" value={f.importo} onChange={set('importo')} placeholder="0.00"/></div>
      <div className="form-group"><label className="form-label">Data</label><input className="form-input" type="date" value={f.data} onChange={set('data')}/></div>
      <div className="form-group full"><label className="form-label">Note</label><textarea className="form-textarea" value={f.note} onChange={set('note')} placeholder="Note aggiuntive..."/></div>
    </div>
    <div className="form-actions">
      <button className="btn btn-ghost" onClick={onClose} disabled={saving}>Annulla</button>
      <button className="btn btn-primary" onClick={save} disabled={saving}>{saving?'‚è≥ Salvataggio...':'üíæ Salva'}</button>
    </div>
  </>);
}

// ‚îÄ‚îÄ‚îÄ MONTHLY CHART COMPONENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function MonthlyCharts({ orders, movimenti }) {
  const currentYear = new Date().getFullYear();
  const [year, setYear] = useState(currentYear);
  const years = [currentYear - 1, currentYear, currentYear + 1];

  // Ordini per mese: margine, grammi movimentati, num ordini
  const monthlyOrders = useMemo(() => {
    const months = Array.from({length:12}, (_,i) => ({ mese: MESI[i], margine:0, grammi:0, ordini:0, fatturato:0 }));
    orders.forEach(o => {
      const d = o.data ? new Date(o.data) : o._ts ? new Date(o._ts) : null;
      if (!d || d.getFullYear() !== year) return;
      const m = d.getMonth();
      months[m].margine   += calcMargine(o);
      months[m].grammi    += n(o.qta);
      months[m].ordini    += 1;
      months[m].fatturato += calcFatturato(o);
    });
    return months;
  }, [orders, year]);

  // Movimenti extra per mese
  const monthlyMov = useMemo(() => {
    const months = Array.from({length:12}, (_,i) => ({ mese: MESI[i], entrate:0, uscite:0 }));
    movimenti.forEach(m => {
      const d = m.data ? new Date(m.data) : m._ts ? new Date(m._ts) : null;
      if (!d || d.getFullYear() !== year) return;
      const idx = d.getMonth();
      if (m.tipo==='entrata') months[idx].entrate += n(m.importo);
      else months[idx].uscite += n(m.importo);
    });
    return months;
  }, [movimenti, year]);

  const maxMargine  = Math.max(...monthlyOrders.map(m=>m.margine), 1);
  const maxGrammi   = Math.max(...monthlyOrders.map(m=>m.grammi), 1);
  const maxMovTotal = Math.max(...monthlyMov.map(m=>m.entrate+m.uscite), 1);

  return (
    <div>
      <div className="section-title">
        Statistiche Mensili
        <select className="year-select" value={year} onChange={e=>setYear(parseInt(e.target.value))}>
          {years.map(y=><option key={y} value={y}>{y}</option>)}
        </select>
      </div>

      <div className="monthly-grid">
        {/* Margine mensile */}
        <div className="month-card">
          <h3>Ricavo Netto per Mese</h3>
          {monthlyOrders.map((m,i) => (
            <div key={i} className="month-bar-row">
              <div className="month-bar-label">{m.mese}</div>
              <div className="month-bar-track">
                <div className="month-bar-fill" style={{width:`${Math.max(0,(m.margine/maxMargine)*100)}%`, background: m.margine>=0?'var(--green)':'var(--red)'}}></div>
              </div>
              <div className="month-bar-val" style={{color:m.margine>0?'var(--green)':m.margine<0?'var(--red)':'var(--text3)'}}>
                {m.margine!==0?(m.margine>0?'+':'')+fmt(m.margine):'‚Äî'}
              </div>
            </div>
          ))}
        </div>

        {/* Grammi movimentati */}
        <div className="month-card">
          <h3>Grammi Movimentati per Mese</h3>
          {monthlyOrders.map((m,i) => (
            <div key={i} className="month-bar-row">
              <div className="month-bar-label">{m.mese}</div>
              <div className="month-bar-track">
                <div className="month-bar-fill" style={{width:`${(m.grammi/maxGrammi)*100}%`, background:'var(--accent)'}}></div>
              </div>
              <div className="month-bar-val" style={{color: m.grammi>0?'var(--accent)':'var(--text3)'}}>
                {m.grammi>0?fmtG(m.grammi):'‚Äî'}
              </div>
            </div>
          ))}
        </div>

        {/* Ordini per mese */}
        <div className="month-card">
          <h3>Numero Ordini per Mese</h3>
          {monthlyOrders.map((m,i) => {
            const maxOrd = Math.max(...monthlyOrders.map(x=>x.ordini), 1);
            return (
              <div key={i} className="month-bar-row">
                <div className="month-bar-label">{m.mese}</div>
                <div className="month-bar-track">
                  <div className="month-bar-fill" style={{width:`${(m.ordini/maxOrd)*100}%`, background:'var(--blue)'}}></div>
                </div>
                <div className="month-bar-val" style={{color: m.ordini>0?'var(--blue)':'var(--text3)'}}>
                  {m.ordini>0?`${m.ordini} ord.`:'‚Äî'}
                </div>
              </div>
            );
          })}
        </div>

        {/* Movimenti finanza per mese */}
        <div className="month-card">
          <h3>Movimenti Finanza per Mese</h3>
          {monthlyMov.map((m,i) => (
            <div key={i} style={{marginBottom:'8px'}}>
              <div style={{display:'flex',alignItems:'center',gap:'8px',marginBottom:'3px'}}>
                <div className="month-bar-label">{m.mese}</div>
                <div style={{flex:1}}>
                  {m.entrate>0 && (
                    <div style={{display:'flex',alignItems:'center',gap:'6px',marginBottom:'2px'}}>
                      <div style={{flex:1,height:'4px',background:'var(--bg3)',borderRadius:'2px',overflow:'hidden'}}>
                        <div style={{width:`${(m.entrate/maxMovTotal)*100}%`,height:'100%',background:'var(--green)',borderRadius:'2px'}}></div>
                      </div>
                      <span style={{fontSize:'10px',color:'var(--green)',fontFamily:'var(--mono)',width:'60px',textAlign:'right'}}>+{fmt(m.entrate)}</span>
                    </div>
                  )}
                  {m.uscite>0 && (
                    <div style={{display:'flex',alignItems:'center',gap:'6px'}}>
                      <div style={{flex:1,height:'4px',background:'var(--bg3)',borderRadius:'2px',overflow:'hidden'}}>
                        <div style={{width:`${(m.uscite/maxMovTotal)*100}%`,height:'100%',background:'var(--red)',borderRadius:'2px'}}></div>
                      </div>
                      <span style={{fontSize:'10px',color:'var(--red)',fontFamily:'var(--mono)',width:'60px',textAlign:'right'}}>-{fmt(m.uscite)}</span>
                    </div>
                  )}
                  {m.entrate===0&&m.uscite===0 && <span style={{fontSize:'10px',color:'var(--text3)',fontFamily:'var(--mono)'}}>‚Äî</span>}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function Dashboard({ orders, movimenti }) {
  // Calcoli globali
  const fatturato   = orders.reduce((s,o)=>s+calcFatturato(o), 0);
  const costoTotale = orders.reduce((s,o)=>s+calcCostoTot(o), 0);
  const margTotale  = orders.reduce((s,o)=>s+calcMargine(o), 0);
  const totAttivi   = orders.filter(o=>!['consegnato','annullato'].includes(o.stato)).length;
  const grammiTot   = orders.reduce((s,o)=>s+n(o.qta), 0);

  // Movimenti finanza extra
  const movEntrate  = movimenti.filter(m=>m.tipo==='entrata').reduce((s,m)=>s+n(m.importo),0);
  const movUscite   = movimenti.filter(m=>m.tipo==='uscita').reduce((s,m)=>s+n(m.importo),0);

  // Saldo totale = margine ordini + movimenti extra entrate - movimenti extra uscite
  const saldoTotale = margTotale + movEntrate - movUscite;

  const recent = [...orders].sort((a,b)=>(b._ts||0)-(a._ts||0)).slice(0,5);
  const statusCount = {};
  orders.forEach(o=>{statusCount[o.stato]=(statusCount[o.stato]||0)+1;});

  const clientiMap = {};
  orders.forEach(o=>{ if(o.cliente) clientiMap[o.cliente]=(clientiMap[o.cliente]||0)+calcMargine(o); });
  const topClienti = Object.entries(clientiMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const maxVal = Math.max(...topClienti.map(([,v])=>v), 1);

  return (<div>
    <div className="page-header">
      <div>
        <div className="page-title">Dashboard</div>
        <div className="page-subtitle">{new Date().toLocaleDateString('it-IT',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
      </div>
    </div>

    {/* KPI principali */}
    <div className="kpi-grid">
      <div className="kpi-card gold"><div className="kpi-icon">üìã</div><div className="kpi-label">Totale Ordini</div><div className="kpi-value gold">{orders.length}</div><div className="kpi-sub">{totAttivi} attivi ‚Ä¢ {fmtG(grammiTot)} tot.</div></div>
      <div className="kpi-card green"><div className="kpi-icon">üí∞</div><div className="kpi-label">Fatturato</div><div className="kpi-value green">{fmt(fatturato)}</div><div className="kpi-sub">Costo: {fmt(costoTotale)}</div></div>
      <div className="kpi-card purple"><div className="kpi-icon">üìà</div><div className="kpi-label">Ricavo Netto Ordini</div><div className={`kpi-value ${margTotale>=0?'green':'red'}`}>{fmt(margTotale)}</div><div className="kpi-sub">vendita ‚àí costo</div></div>
      <div className="kpi-card blue"><div className="kpi-icon">‚öñ</div>
        <div className="kpi-label">Saldo Totale</div>
        <div className={`kpi-value ${saldoTotale>=0?'green':'red'}`}>{fmt(saldoTotale)}</div>
        <div className="kpi-sub">ordini + finanza extra</div>
      </div>
    </div>

    {/* Ordini recenti + top clienti */}
    <div className="dash-row">
      <div className="table-container">
        <div className="table-toolbar" style={{justifyContent:'space-between'}}>
          <span style={{fontSize:'13px',fontWeight:'700'}}>Ordini Recenti</span>
          <span className="tag">ultime 5</span>
        </div>
        {recent.length===0
          ? <div className="empty-state"><div className="icon">üì¶</div><p>Nessun ordine ancora</p></div>
          : <table><thead><tr><th>Cliente</th><th>Prodotto</th><th>Grammi</th><th>Ricavo</th><th>Stato</th></tr></thead>
            <tbody>{recent.map(o=>{
              const m = calcMargine(o);
              return (<tr key={o.id}>
                <td style={{fontWeight:'600'}}>{o.cliente}</td>
                <td style={{color:'var(--text2)',maxWidth:'100px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{o.prodotto}</td>
                <td className="mono" style={{color:'var(--accent)'}}>{fmtG(o.qta)}</td>
                <td className={m>=0?'amount-pos':'amount-neg'}>{m>=0?'+':''}{fmt(m)}</td>
                <td><span className={`status-badge ${STATUS_MAP[o.stato]?.cls}`}>{STATUS_MAP[o.stato]?.label}</span></td>
              </tr>);
            })}</tbody></table>
        }
      </div>

      <div style={{display:'flex',flexDirection:'column',gap:'14px'}}>
        <div className="fin-card" style={{padding:'18px'}}>
          <h3>Top Clienti per Ricavo</h3>
          {topClienti.length===0
            ? <div style={{color:'var(--text3)',fontSize:'12px',textAlign:'center',padding:'14px'}}>Nessun dato</div>
            : topClienti.map(([name,val])=>(
              <div key={name} className="mini-bar-row">
                <div className="mini-bar-label">{name}</div>
                <div className="mini-bar-track"><div className="mini-bar-fill" style={{width:`${Math.max(0,(val/maxVal)*100)}%`,background:val>=0?'var(--green)':'var(--red)'}}></div></div>
                <div className="mini-bar-val" style={{color:val>=0?'var(--green)':'var(--red)'}}>{fmt(val)}</div>
              </div>
            ))
          }
        </div>
        {orders.length>0 && (
          <div className="fin-card" style={{padding:'18px'}}>
            <h3>Stato Ordini</h3>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'8px'}}>
              {Object.entries(STATUS_MAP).map(([k,v])=>(
                <div key={k} style={{textAlign:'center',background:'var(--bg3)',borderRadius:'8px',padding:'10px 4px'}}>
                  <div style={{fontSize:'22px',fontWeight:'800',color:k==='consegnato'?'var(--green)':k==='annullato'?'var(--red)':k==='lavorazione'?'var(--accent)':'var(--text)'}}>{statusCount[k]||0}</div>
                  <div style={{fontSize:'9px',color:'var(--text3)',fontFamily:'var(--mono)',letterSpacing:'0.5px',textTransform:'uppercase',marginTop:'2px'}}>{v.label}</div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>

    {/* Grafici mensili */}
    <MonthlyCharts orders={orders} movimenti={movimenti} />
  </div>);
}

// ‚îÄ‚îÄ‚îÄ ORDINI PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function OrdiniPage({ col }) {
  const { data: orders, add, update, remove } = col;
  const [modal, setModal] = useState(null);
  const [selected, setSelected] = useState(null);
  const [search, setSearch] = useState('');
  const [filterStato, setFilterStato] = useState('');
  const [saving, setSaving] = useState(false);

  const filtered = useMemo(()=>orders.filter(o=>{
    const s=search.toLowerCase();
    return (!s||o.cliente?.toLowerCase().includes(s)||o.prodotto?.toLowerCase().includes(s))&&(!filterStato||o.stato===filterStato);
  }).sort((a,b)=>(b._ts||0)-(a._ts||0)),[orders,search,filterStato]);

  const totFatturato = filtered.reduce((s,o)=>s+calcFatturato(o),0);
  const totMargine   = filtered.reduce((s,o)=>s+calcMargine(o),0);
  const totGrammi    = filtered.reduce((s,o)=>s+n(o.qta),0);

  const saveOrder = async f => { setSaving(true); try { if(modal==='new') await add(f); else await update(selected.id,f); setModal(null); } catch(e){alert('Errore: '+e.message);} setSaving(false); };
  const deleteOrder = async () => { setSaving(true); try { await remove(selected.id); setModal(null); } catch(e){alert('Errore: '+e.message);} setSaving(false); };

  return (<div>
    <div className="page-header">
      <div>
        <div className="page-title">Ordini</div>
        <div className="page-subtitle">
          {filtered.length} ordini ‚Ä¢ {fmtG(totGrammi)} ‚Ä¢ Fatturato: {fmt(totFatturato)} ‚Ä¢ Ricavo netto: <span style={{color:'var(--green)'}}>{fmt(totMargine)}</span>
        </div>
      </div>
      <button className="btn btn-primary" onClick={()=>{setSelected(null);setModal('new')}}>+ Nuovo Ordine</button>
    </div>
    <div className="table-container">
      <div className="table-toolbar">
        <div className="search-box"><span style={{color:'var(--text3)'}}>‚åï</span><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca cliente o prodotto..."/></div>
        <select className="filter-select" value={filterStato} onChange={e=>setFilterStato(e.target.value)}>
          <option value="">Tutti gli stati</option>
          {Object.entries(STATUS_MAP).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
        </select>
      </div>
      {filtered.length===0
        ? <div className="empty-state"><div className="icon">üì¶</div><p>Nessun ordine trovato</p></div>
        : <div style={{overflowX:'auto'}}>
          <table><thead><tr>
            <th>#</th><th>Cliente</th><th>Prodotto</th><th>Grammi</th><th>P.Vendita/g</th><th>P.Costo/g</th><th>Fatturato</th><th>Ricavo Netto</th><th>Stato</th><th>Data</th><th></th>
          </tr></thead>
          <tbody>{filtered.map((o,i)=>{
            const m = calcMargine(o);
            const tv = calcFatturato(o);
            return (<tr key={o.id}>
              <td><span className="tag mono">{String(i+1).padStart(3,'0')}</span></td>
              <td>
                <div style={{fontWeight:'600'}}>{o.cliente}</div>
                {o.telefono&&<div style={{fontSize:'11px',color:'var(--text3)',fontFamily:'var(--mono)'}}>{o.telefono}</div>}
              </td>
              <td style={{maxWidth:'130px'}}>
                <div style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{o.prodotto}</div>
                {o.note&&<div style={{fontSize:'11px',color:'var(--text3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{o.note}</div>}
              </td>
              <td className="mono" style={{color:'var(--accent)'}}>{fmtG(o.qta)}</td>
              <td className="mono">{fmt(o.prezzoVendita)}</td>
              <td className="mono" style={{color:'var(--text2)'}}>{n(o.prezzoCosto)>0?fmt(o.prezzoCosto):'‚Äî'}</td>
              <td className="amount-neutral">{fmt(tv)}</td>
              <td className={m>=0?'amount-pos':'amount-neg'}>{m>=0?'+':''}{fmt(m)}</td>
              <td><span className={`status-badge ${STATUS_MAP[o.stato]?.cls}`}>{STATUS_MAP[o.stato]?.label}</span></td>
              <td className="mono" style={{color:'var(--text3)',fontSize:'12px'}}>{fmtDate(o.data)}</td>
              <td><div className="action-btns">
                <button className="btn btn-ghost btn-sm" onClick={()=>{setSelected(o);setModal('edit')}}>‚úé</button>
                <button className="btn btn-danger btn-sm" onClick={()=>{setSelected(o);setModal('delete')}}>‚å´</button>
              </div></td>
            </tr>);
          })}</tbody></table>
        </div>
      }
    </div>
    <Modal open={modal==='new'||modal==='edit'} onClose={()=>setModal(null)}>
      <OrderForm initial={selected} onSave={saveOrder} onClose={()=>setModal(null)} title={modal==='new'?'Nuovo Ordine':'Modifica Ordine'} saving={saving}/>
    </Modal>
    <Modal open={modal==='delete'} onClose={()=>setModal(null)}>
      <h2>Elimina Ordine</h2><div className="modal-sub">Questa azione non pu√≤ essere annullata</div>
      <div className="confirm-box"><p>Elimina ordine di <strong>{selected?.cliente}</strong> ‚Äî <strong>{selected?.prodotto}</strong>?</p></div>
      <div className="form-actions">
        <button className="btn btn-ghost" onClick={()=>setModal(null)} disabled={saving}>Annulla</button>
        <button className="btn btn-danger" onClick={deleteOrder} disabled={saving}>{saving?'‚è≥...':'‚å´ Elimina'}</button>
      </div>
    </Modal>
  </div>);
}

// ‚îÄ‚îÄ‚îÄ FINANZA PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function FinanzaPage({ col, orders }) {
  const { data: movimenti, add, update, remove } = col;
  const [modal, setModal] = useState(null);
  const [selected, setSelected] = useState(null);
  const [search, setSearch] = useState('');
  const [filterTipo, setFilterTipo] = useState('');
  const [saving, setSaving] = useState(false);

  // Ricavo automatico dagli ordini
  const ricavoOrdini = orders.reduce((s,o)=>s+calcMargine(o), 0);
  const costoOrdini  = orders.reduce((s,o)=>s+calcCostoTot(o), 0);

  // Movimenti extra
  const movEntrate = movimenti.filter(m=>m.tipo==='entrata').reduce((s,m)=>s+n(m.importo),0);
  const movUscite  = movimenti.filter(m=>m.tipo==='uscita').reduce((s,m)=>s+n(m.importo),0);

  // Saldo totale = ricavo ordini + movimenti entrate - movimenti uscite
  const saldoTotale = ricavoOrdini + movEntrate - movUscite;

  const filtered = useMemo(()=>movimenti.filter(m=>{
    const s=search.toLowerCase();
    return(!s||m.descrizione?.toLowerCase().includes(s)||m.categoria?.toLowerCase().includes(s))&&(!filterTipo||m.tipo===filterTipo);
  }).sort((a,b)=>(b._ts||0)-(a._ts||0)),[movimenti,search,filterTipo]);

  const saveMov = async f => { setSaving(true); try { if(modal==='new') await add(f); else await update(selected.id,f); setModal(null); } catch(e){alert('Errore: '+e.message);} setSaving(false); };
  const deleteMov = async () => { setSaving(true); try { await remove(selected.id); setModal(null); } catch(e){alert('Errore: '+e.message);} setSaving(false); };

  return (<div>
    <div className="page-header">
      <div><div className="page-title">Finanza</div>
        <div className="page-subtitle">Saldo totale: <span style={{color:saldoTotale>=0?'var(--green)':'var(--red)'}}>{fmt(saldoTotale)}</span></div>
      </div>
      <button className="btn btn-primary" onClick={()=>{setSelected(null);setModal('new')}}>+ Movimento Extra</button>
    </div>

    {/* KPI finanza */}
    <div className="kpi-grid" style={{gridTemplateColumns:'repeat(3,1fr)',marginBottom:'20px'}}>
      <div className="kpi-card green">
        <div className="kpi-label">Ricavo da Ordini</div>
        <div className={`kpi-value ${ricavoOrdini>=0?'green':'red'}`}>{fmt(ricavoOrdini)}</div>
        <div className="kpi-sub">{orders.length} ordini ‚Ä¢ costo {fmt(costoOrdini)}</div>
      </div>
      <div className="kpi-card gold">
        <div className="kpi-label">Movimenti Extra</div>
        <div className="kpi-value gold">{fmt(movEntrate - movUscite)}</div>
        <div className="kpi-sub">+{fmt(movEntrate)} / -{fmt(movUscite)}</div>
      </div>
      <div className="kpi-card blue">
        <div className="kpi-label">Saldo Totale</div>
        <div className={`kpi-value ${saldoTotale>=0?'green':'red'}`}>{fmt(saldoTotale)}</div>
        <div className="kpi-sub">{saldoTotale>=0?'‚úì in attivo':'‚úó in passivo'}</div>
      </div>
    </div>

    {/* Tabella movimenti extra */}
    <div className="section-title" style={{marginBottom:'12px'}}>Movimenti Manuali Extra <span>separati dal ricavo automatico degli ordini</span></div>
    <div className="table-container">
      <div className="table-toolbar">
        <div className="search-box"><span style={{color:'var(--text3)'}}>‚åï</span><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Cerca..."/></div>
        <select className="filter-select" value={filterTipo} onChange={e=>setFilterTipo(e.target.value)}>
          <option value="">Tutti</option><option value="entrata">‚Üò Entrate</option><option value="uscita">‚Üó Uscite</option>
        </select>
      </div>
      {filtered.length===0
        ? <div className="empty-state"><div className="icon">üí∞</div><p>Nessun movimento extra registrato</p></div>
        : <div style={{overflowX:'auto'}}>
          <table><thead><tr><th>Tipo</th><th>Descrizione</th><th>Categoria</th><th>Importo</th><th>Data</th><th>Note</th><th></th></tr></thead>
          <tbody>{filtered.map(m=>(
            <tr key={m.id}>
              <td>{m.tipo==='entrata'?<span className="status-badge s-consegnato">‚Üò Entrata</span>:<span className="status-badge s-annullato">‚Üó Uscita</span>}</td>
              <td style={{fontWeight:'500'}}>{m.descrizione}</td>
              <td>{m.categoria&&<span className="tag">{m.categoria}</span>}</td>
              <td className={m.tipo==='entrata'?'amount-pos':'amount-neg'}>{m.tipo==='entrata'?'+':'-'}{fmt(m.importo)}</td>
              <td className="mono" style={{color:'var(--text3)',fontSize:'12px'}}>{fmtDate(m.data)}</td>
              <td style={{color:'var(--text3)',fontSize:'12px',maxWidth:'120px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{m.note||'‚Äî'}</td>
              <td><div className="action-btns">
                <button className="btn btn-ghost btn-sm" onClick={()=>{setSelected(m);setModal('edit')}}>‚úé</button>
                <button className="btn btn-danger btn-sm" onClick={()=>{setSelected(m);setModal('delete')}}>‚å´</button>
              </div></td>
            </tr>
          ))}</tbody></table>
        </div>
      }
    </div>
    <Modal open={modal==='new'||modal==='edit'} onClose={()=>setModal(null)}>
      <MovimentoForm initial={selected} onSave={saveMov} onClose={()=>setModal(null)} title={modal==='new'?'Nuovo Movimento Extra':'Modifica Movimento'} saving={saving}/>
    </Modal>
    <Modal open={modal==='delete'} onClose={()=>setModal(null)}>
      <h2>Elimina Movimento</h2><div className="modal-sub">Questa azione non pu√≤ essere annullata</div>
      <div className="confirm-box"><p>Elimina: <strong>{selected?.descrizione}</strong> ‚Äî {fmt(selected?.importo)}?</p></div>
      <div className="form-actions">
        <button className="btn btn-ghost" onClick={()=>setModal(null)} disabled={saving}>Annulla</button>
        <button className="btn btn-danger" onClick={deleteMov} disabled={saving}>{saving?'‚è≥...':'‚å´ Elimina'}</button>
      </div>
    </Modal>
  </div>);
}

// ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const ordersCol    = useFirestoreCollection('ordini');
  const movimentiCol = useFirestoreCollection('movimenti');
  const [page, setPage]     = useState('dashboard');
  const [online, setOnline] = useState(navigator.onLine);

  useEffect(()=>{
    const up=()=>setOnline(true), dn=()=>setOnline(false);
    window.addEventListener('online',up); window.addEventListener('offline',dn);
    return()=>{ window.removeEventListener('online',up); window.removeEventListener('offline',dn); };
  },[]);

  if (!ordersCol.ready || !movimentiCol.ready) return (
    <div className="loading-screen">
      <div className="spinner"></div>
      <div className="loading-text">CONNESSIONE A FIREBASE...</div>
    </div>
  );

  const totAttivi = ordersCol.data.filter(o=>!['consegnato','annullato'].includes(o.stato)).length;
  const navItems = [
    { id:'dashboard', icon:'‚óà', label:'Dashboard' },
    { id:'ordini',    icon:'üìã', label:'Ordini', badge: totAttivi||null },
    { id:'finanza',   icon:'üí∞', label:'Finanza' },
  ];

  return (
    <div className="layout">
      <aside className="sidebar">
        <div className="logo">
          <div className="logo-mark">Sistema</div>
          <h1>Gestionale<em>.</em><span className={`sync-dot${online?'':' offline'}`} title={online?'Sincronizzato':'Offline'}></span></h1>
        </div>
        <nav className="nav">
          <div className="nav-section">Menu</div>
          {navItems.map(item=>(
            <div key={item.id} className={`nav-item${page===item.id?' active':''}`} onClick={()=>setPage(item.id)}>
              <span className="icon">{item.icon}</span>{item.label}
              {item.badge?<span className="nav-badge">{item.badge}</span>:null}
            </div>
          ))}
        </nav>
        <div className="sidebar-footer">
          <div className="sf-label">Ordini Totali</div>
          <div className="sf-value">{ordersCol.data.length}</div>
          <div className={`live-badge ${online?'on':'off'}`}>{online?'‚óè FIREBASE LIVE':'‚óè OFFLINE'}</div>
        </div>
      </aside>
      <main className="main">
        {page==='dashboard' && <Dashboard orders={ordersCol.data} movimenti={movimentiCol.data}/>}
        {page==='ordini'    && <OrdiniPage col={ordersCol}/>}
        {page==='finanza'   && <FinanzaPage col={movimentiCol} orders={ordersCol.data}/>}
      </main>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
